<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <title>Your Assistant</title>
    <style>
        :root {
            --primary-color: #006633;
            --secondary-color: #FFCC33;
            --text-light: #ffffff;
            --text-dark: #333333;
        }

        #chatbot-icon {
            position: fixed;
            bottom: 20px;
            right: 20px;
            cursor: pointer;
            z-index: 1050;
        }

        #chat-iframe {
            display: none;
            position: fixed;
            bottom: 80px;
            right: 20px;
            width: 500px;
            height: 500px;
            border: 1px solid #ccc;
            background-color: white;
            z-index: 1000;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            border-radius: 8px;
            transition: all 0.3s ease;
        }

        #chat-iframe.expanded {
            width: 350px;
            height: 500px;
        }

        #chat-window {
            display: none;
            position: fixed;
            bottom: 80px;
            right: 20px;
            /* height: 450px; */
            width: 500px;
            background-color: white;
            border: 1px solid #ccc;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            border-radius: 8px;
            z-index: 1050;
        }

        #chat-header {
            background-color: var(--primary-color);
            color: var(--text-light);
            padding: 10px;
            font-weight: bold;
            text-align: center;
            border-top-left-radius: 8px;
            border-top-right-radius: 8px;
            position: relative;
            font-size: large;
        }

        #chat-messages {
            height: 450px;
            overflow-y: auto;
            padding: 10px;
            font-size: 20px;
        }

        #user-input {
            width: calc(100% - 45px);
            padding: 10px;
            border: 1px solid #ccc;
            margin: 5px 10px;
            border-radius: 4px;
        }

        #close-chat {
            position: absolute;
            top: 3px;
            right: 10px;
            cursor: pointer;
            color: var(--text-light);
            font-size: 30px;
        }

        #close-chat:hover {
            color: var(--text-dark);
        }

        #send-button {
            width: calc(100% - 22px);
            padding: 10px;
            background-color: var(--secondary-color);
            color: white;
            border: none;
            border-radius: 4px;
            margin: 5px 10px;
            cursor: pointer;
        }

        #send-button:hover {
            background-color: var(--primary-color);
        }

        .preview-container {
            max-width: 300px;
            margin: 10px 0;
            border: 1px solid #ccc;
            border-radius: 4px;
            overflow: hidden;
            background: #f5f5f5;
            transition: all 0.3s ease;
        }

        .preview-container:hover {
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        .preview-image {
            max-width: 100%;
            height: auto;
            display: block;
            min-height: 100px;
            background: #f5f5f5;
            transition: transform 0.3s ease;
        }

        .preview-image:hover {
            transform: scale(1.02);
        }

        .error-image {
            border: 1px solid #ffdddd;
            background: #fff5f5;
            max-height: 200px;
            object-fit: contain;
            padding: 10px;
        }

        .pdf-link {
            display: flex;
            align-items: center;
            padding: 10px;
            background: #f5f5f5;
            color: #006633;
            text-decoration: none;
            gap: 8px;
        }

        .pdf-link:hover {
            background: #e5e5e5;
        }
    </style>
</head>

<body>
    <div id="chatbot-icon">
        <i class="fas fa-comments" style="font-size: 50px; color: var(--primary-color);"></i>
    </div>

    <!-- Chatbot Window -->
    <div id="chat-window">
        <div id="chat-header">Your Assistant <span id="close-chat">&times;</span></div>
        <div id="chat-messages"></div>
        <input type="text" id="user-input" placeholder="Type a message...">
        <button id="send-button">Send</button>
    </div>


    <script>
        // Add session ID generation
        const sessionId = 'session_' + Date.now();

        // Update the isProduction check to specifically look for GitHub Pages domain
        const isProduction = window.location.hostname === 'physicslabgmu.github.io';
        const API_URL = isProduction
            ? 'https://physicslabgmu.onrender.com/api/chat'
            : 'http://localhost:10000/api/chat';

        console.log('Current API URL:', API_URL); // Add this for debugging

        // Fix chat window toggle
        document.getElementById('chatbot-icon').onclick = function () {
            const chatWindow = document.getElementById('chat-window');
            chatWindow.style.display = chatWindow.style.display === 'none' ? 'block' : 'none';
        };

        document.getElementById('close-chat').onclick = function () {
            document.getElementById('chat-window').style.display = 'none';
        };



        async function sendMessage() {
            const userInput = document.getElementById('user-input').value.trim();
            const chatMessages = document.getElementById('chat-messages');

            if (userInput) {
                try {
                    chatMessages.innerHTML += `<div><strong>User:</strong> ${userInput}</div>`;
                    document.getElementById('user-input').value = '';

                    const response = await fetch(API_URL, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Accept': 'application/json'
                        },
                        body: JSON.stringify({
                            prompt: userInput,
                            sessionId: sessionId
                        })
                    });

                    if (!response.ok) {
                        throw new Error(`Server returned ${response.status}: ${response.statusText}`);
                    }

                    const data = await response.json();
                    const botResponse = data?.candidates?.[0]?.content?.parts?.[0]?.text || "Sorry, I couldn't generate a response.";
                    const messageDiv = document.createElement('div');
                    messageDiv.innerHTML = `<strong>Assistant:</strong> ${botResponse}`;

                    // Enhanced image handling
                    messageDiv.querySelectorAll('img').forEach(img => {
                        img.loading = "lazy";
                        img.style.opacity = "0";
                        img.onload = function () {
                            this.style.opacity = "1";
                        };
                        img.onerror = function () {
                            this.onerror = null;
                            this.src = 'https://via.placeholder.com/300x200?text=Image+Not+Available';
                            this.classList.add('error-image');
                        };
                    });

                    chatMessages.appendChild(messageDiv);
                    chatMessages.scrollTop = chatMessages.scrollHeight;
                } catch (error) {
                    console.error('Fetch error:', error);
                    chatMessages.innerHTML += `<div><strong>Assistant:</strong> Error connecting to server. Please try again later. (${error.message})</div>`;
                }
            }
        }

        document.getElementById('send-button').onclick = sendMessage;

        document.getElementById('user-input').addEventListener('keypress', function (event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        });



    </script>
</body>

</html>

</html>
